<template>
  <div style="width: 100%; height: 100%; float: right; padding: 20px;box-sizing: border-box;" class=" overflow-hidden">
    <p v-for="list in messages" style="word-break: break-all; margin-bottom: 5px;">{{ list.join(" ") }}</p>
  </div>
</template>

<style scoped></style>

<script setup>
import { GpuComputed, AtomicUint32Array } from "@/utils/GpuComputed"
import * as WGSL_Fun from "@/utils/WGSL_Fun"
import { reactive } from "vue"

const messages = reactive([])
const log = console.log
console.log = (...msgs) => {
  log(...msgs)
  messages.push(msgs.map(msg => String(msg)))
}

function randFloat(min, max) {
    return min + Math.random() * (max - min)
}

async function start() {
    await GpuComputed.init()

    // 创建计算模版类
    const gpuComputed = await GpuComputed.fromByData({
        data: {
            obbList: [{ quaternion: [0, 0, 0, 0], size: [0, 0, 0], center: [0, 0, 0] }],
            points: new Float32Array(),
            results: new AtomicUint32Array(),
        },
        workgroupSize: [256, 1, 1],
        beforeCodes: [WGSL_Fun.quat_rotate, WGSL_Fun.point_in_obb],
        code: `
            if (index >= arrayLength(&points)) {
                return;
            }

            let point = vec3<f32>(
                points[index * 3u],
                points[index * 3u + 1u],
                points[index * 3u + 2u]
            );

            let obbLength = arrayLength(&obbList);

            for (var i = 0u; i < obbLength; i++) {
                let obb = obbList[i];
                let inside = point_in_obb(point, obb.center, obb.size, obb.quaternion);

                if (inside) {
                    let halfIndex = index >> 1u;
                    let value = (i + 1u) & 0xFFFFu;

                    if ((index & 1u) == 0u) {
                        // 写低 16 位
                        atomicOr(&results[halfIndex], value);
                    } else {
                        // 写高 16 位
                        atomicOr(&results[halfIndex], value << 16u);
                    }
                    break;
                }
            }
        `,
    })

    // 初始化计算数据
    const points = new Float32Array(1000_0000 * 3)
        , obbList = [{ "size": [0.007739894512914525, 0.03387093474704315, 0.028774648904800415], "center": [-0.9964762635758575, -2.1936060094573815, 0.40974709391593933], "quaternion": [0, 0, 0.906898468286134, -0.421349223590437] }, { "size": [0.05310014409550475, 0.26236251818727585, 0.22331168502569199], "center": [-1.963442955544906, -1.3068708960918551, -0.087555892765522], "quaternion": [0, 0, 0.9033317032655578, -0.42894269299679927] }, { "size": [0.06951802407703929, 0.7662144142910113, 0.4513377547264099], "center": [2.2019143804079135, 3.350500615939949, 0.1786729097366333], "quaternion": [0, 0, 0.4215415569902713, 0.9068090844991671] }, { "size": [0.2376495700628506, 0.5124519435477386, 0.4717581272125244], "center": [-1.1724391857582646, 0.3542407150435109, -0.4141833186149597], "quaternion": [0, 0, 0.8546875240138323, 0.5191427898903199] }, { "size": [0.2300846467622861, 1.3659132835729888, 1.345034807920456], "center": [-1.888566077025132, 0.42575098846535786, 0.4639759361743927], "quaternion": [0, 0, -0.3503030200200753, 0.9366364258157029] }, { "size": [0.26920166945558277, 0.3122115603364043, 0.5106511488556862], "center": [-1.4595753622651273, -1.398770900950171, -0.37203898280858994], "quaternion": [0, 0, 0.9335899680465174, 0.35834309197039454] }, { "size": [0.5558841621534876, 1.0321724240098418, 0.42554542794823647], "center": [-0.704896886130598, -0.3217787791157962, -0.46209290251135826], "quaternion": [0, 0, 0.9404090704152601, 0.3400452621059532] }, { "size": [0.10080589029429136, 0.284197720408246, 0.47045558504760265], "center": [-0.4679841224222514, -0.8298819368973098, -0.4164464492350817], "quaternion": [0, 0, -0.3094693261430253, 0.9509094258532628] }, { "size": [0.5796636165948811, 1.4804797886079926, 0.4666841924190521], "center": [0.38321016198818825, 2.648070649130266, -0.42081794142723083], "quaternion": [0, 0, 0.9351974348545927, 0.35412675391925696] }, { "size": [0.18952099240265524, 0.8772173319227168, 0.46510952711105347], "center": [1.5945128795437427, -3.9004042742337113, 1.1183149218559265], "quaternion": [0, 0, 0.5351944263446229, 0.8447289068154648] }, { "size": [0.011903466059919795, 0.04569329203846916, 0.04237702488899231], "center": [3.300854158662048, 0.8639880645414757, 0.42362016439437866], "quaternion": [0, 0, 0.9353977718631966, 0.353597240364468] }, { "size": [0.20584489132486727, 0.24462170318451584, 0.22173473238945007], "center": [0.012536802953206916, 0.4090750300804624, -0.6658072769641876], "quaternion": [0, 0, 0.9350468610638409, 0.35452414249900976] }, { "size": [0.22370936100829042, 0.24831441006995564, 0.214518204331398], "center": [-0.6306777406221613, 1.2799888364155252, -0.6731138080358505], "quaternion": [0, 0, 0.8970234116276011, -0.44198303020815094] }, { "size": [0.10451754181906933, 0.15445388989160558, 0.16340777277946472], "center": [5.741631919862584, 1.212956378630886, 0.7863965332508087], "quaternion": [0, 0, -0.7902289769166297, 0.6128116872590607] }, { "size": [0.19264152662576267, 0.17948456103123947, 0.1849636733531952], "center": [6.301049829331589, -1.01258512495271, -0.702517956495285], "quaternion": [0, 0, 0.9342601915091592, 0.35659205622289064] }, { "size": [0.07391504203923611, 0.2368901957872335, 0.19412782043218613], "center": [6.474520863622388, 0.5104294198266126, -0.3193860426545143], "quaternion": [0, 0, 0.4046373563609791, 0.9144772330884996] }, { "size": [0.11529971147613506, 0.21107999194304838, 0.15126051008701324], "center": [-1.8856844599346232, -1.09780484770186, -0.34484316408634186], "quaternion": [0, 0, 0.7985466037505751, 0.60193298766426] }, { "size": [0.027487815484556904, 0.03425142458569374, 0.9565037190914154], "center": [6.800224370506953, 0.3344363077598256, 0.27964678406715393], "quaternion": [0, 0, 0.3342924289955407, 0.9424694010503797] }, { "size": [0.012304578685329044, 0.03327531726088938, 0.169703871011734], "center": [6.6928543245172705, 0.41197387770522254, -0.12464860081672668], "quaternion": [0, 0, -0.3566184211966158, 0.9342501279974401] }, { "size": [0.02045858207995842, 0.09012474898719608, 0.2511337101459503], "center": [7.1052934024472165, -0.009167727599269034, 0.8566872775554657], "quaternion": [0, 0, 0.8338271261146939, 0.5520256549792866] }, { "size": [0.2555389678109132, 0.2959809134763399, 0.491524837911129], "center": [3.0950947114014866, -1.387819990142119, -0.39568398147821426], "quaternion": [0, 0, 0.9198307814172311, -0.39231534963262166] }, { "size": [0.011494553735078506, 0.038106175850292676, 0.08282373752444983], "center": [6.6036136355238, 0.5194325840647438, -0.08868648204952478], "quaternion": [0, 0, -0.2833829327035089, 0.9590068370206538] }, { "size": [0.1262638108437534, 0.30248092674535015, 0.21926112473011017], "center": [5.976173971312619, 0.6309901367296125, -0.4386201351881027], "quaternion": [0, 0, -0.613642329140098, 0.7895841259090229] }, { "size": [0.010269873291908403, 0.026869355330925448, 0.15577353304252028], "center": [6.703539595549898, 0.4145043800796759, 0.163963305298239], "quaternion": [0, 0, -0.17555871298917272, 0.9844689625852028] }, { "size": [0.19348124418676976, 0.2886853933429834, 0.4685812685638666], "center": [-0.08832707442854826, -0.34616054826820086, -0.4183303024619818], "quaternion": [0, 0, -0.032122943017496075, 0.9994839250992957] }, { "size": [0.0327675464068685, 0.2008211533168519, 0.06427593529224396], "center": [-0.24037767588686165, 0.28526473082529674, -0.40726594626903534], "quaternion": [0, 0, 0.46177960824087916, 0.8869946975111521] }, { "size": [0.08795506569826288, 0.3683828017362566, 0.20786938443779945], "center": [4.993117555735637, -0.7904901054339083, 0.12658553943037987], "quaternion": [0, 0, 0.4067224217301833, 0.9135517892609784] }, { "size": [0.025267202498101216, 0.24819972228409823, 0.18639668822288513], "center": [5.400852212402128, -1.369554077262097, 1.1258924305438995], "quaternion": [0, 0, 0.41167899749759923, 0.9113289214215533] }, { "size": [0.010190325518770152, 0.04358484833304052, 0.03587798774242401], "center": [5.240559176729562, 0.9105421338333715, 0.437879279255867], "quaternion": [0, 0, -0.3632227849520082, 0.9317023175305015] }, { "size": [0.025240753462067625, 0.07698334007953443, 0.053045764565467834], "center": [5.474639198808063, 1.1552182232246384, 0.4450192302465439], "quaternion": [0, 0, -0.34657304070031025, 0.9380229887693272] }, { "size": [0.4700037760550444, 0.9874621606961914, 0.21930981427431107], "center": [3.703399808495135, -2.4039225567505422, -0.0986313745379448], "quaternion": [0, 0, 0.8693487114359009, -0.49419916827604937] }, { "size": [0.03299624044516313, 0.47426196128979947, 0.18810546398162842], "center": [4.084148868116188, -0.22358600369758042, 1.1265573501586914], "quaternion": [0, 0, 0.9117774146180322, -0.41068472846267] }, { "size": [0.19956707660848044, 0.2417465173198003, 0.4851491376757622], "center": [3.469285217392894, 0.2644576289160139, -0.40248144418001175], "quaternion": [0, 0, -0.8103593253412225, 0.5859332417882767] }, { "size": [0.0687198089426332, 0.24522208401599307, 0.17195791006088257], "center": [3.4750635693832805, 0.30983584663433955, 0.7573062181472778], "quaternion": [0, 0, 0.4882465274217381, 0.8727057513621724] }, { "size": [0.2240729583894497, 1.2408423515385583, 0.36793364584445953], "center": [4.521809034309001, -0.7179010279474889, -0.5186959952116013], "quaternion": [0, 0, 0.9128793201885166, -0.408229527070436] }, { "size": [0.0033460423839454766, 0.044151633964701564, 0.028677061200141907], "center": [3.5732476412767937, 0.5432869842808437, 0.4093516916036606], "quaternion": [0, 0, 0.9203441725351905, -0.3911094528140627] }, { "size": [0.17754014205864063, 0.20803057131113312, 0.2131262719631195], "center": [6.155500172350514, 0.20918079481974586, -0.673746794462204], "quaternion": [0, 0, -0.33940911567280707, 0.9406388532259355] }, { "size": [0.008740406684912059, 0.22038103654370308, 0.3180684447288513], "center": [2.215888897398031, -2.4762778051006635, 1.0513383746147156], "quaternion": [0, 0, 0.907840500352692, -0.41931566381352103] }, { "size": [0.07272314603221151, 0.35049605190506566, 0.5644190609455109], "center": [2.995519463132041, -2.2693041788454553, 1.2179041802883148], "quaternion": [0, 0, 0.9123708196170859, -0.4093647365262998] }, { "size": [0.027311143394896018, 0.23696275238821116, 0.32134342193603516], "center": [1.897191230837734, -2.170642425212426, 1.0309553146362305], "quaternion": [0, 0, 0.4240238068347203, 0.905651042751783] }, { "size": [0.152940183292845, 0.2437038072202835, 0.4594334065914154], "center": [2.9188222694169212, -3.2712027755473723, 1.1114478409290314], "quaternion": [0, 0, 0.396429650364101, 0.918065102436748] }, { "size": [0.09635515997748813, 0.5640530507826104, 0.3925367742776871], "center": [2.2172348305408605, -3.5121719425665177, -0.477844700217247], "quaternion": [0, 0, -0.4126599260967974, 0.9108851658654815] }, { "size": [0.027257554584143116, 0.6724559256137379, 0.36446065455675125], "center": [2.115538014268907, -2.608702974765878, -0.5228636786341667], "quaternion": [0, 0, 0.4125568922244667, 0.9109318364609341] }, { "size": [0.07937339296706987, 0.5855850672210282, 1.330919325351715], "center": [2.5877491644063753, -1.2507545929503752, 0.5275889039039612], "quaternion": [0, 0, 0.4114858270192604, 0.9114161586027952] }, { "size": [0.00789624644657036, 0.03841434913015882, 0.03374303877353668], "center": [1.0258386523426566, -3.9040590802857396, 0.22943015396595], "quaternion": [0, 0, 0.4446848322853535, 0.89568711051089] }, { "size": [0.008415901975489195, 0.03475242670295159, 0.045419007539749146], "center": [0.9569995255009189, -3.847496835170709, 0.2403789758682251], "quaternion": [0, 0, 0.9546829994151401, -0.29762454641328134] }, { "size": [0.009192092502006904, 0.04629125815346384, 0.008464187383651733], "center": [0.8955662714269579, -3.787764459343605, 0.27810701727867126], "quaternion": [0, 0, 0.48018176443318794, 0.8771690105708423] }, { "size": [0.0038433690560009917, 0.08590747183631472, 0.1789752095937729], "center": [1.1078465492481087, -3.90418428642265, 0.49612970650196075], "quaternion": [0, 0, 0.9994222721290535, 0.03398708537665487] }, { "size": [0.10607942832195147, 0.3759917936286752, 0.9234026670455933], "center": [0.9116214458317131, -2.926008803083249, 0.03584110736846924], "quaternion": [0, 0, 0.5055958225765135, 0.8627704585770068] }, { "size": [0.04172143633603962, 0.2850800822185519, 0.19725772738456726], "center": [1.2953239911614105, -1.406484164098671, 0.7389727532863617], "quaternion": [0, 0, 0.9314847750645572, 0.36378030983401416] }, { "size": [0.1708226454786738, 0.8787167618607118, 0.2115468829870224], "center": [2.4342877557697875, 2.911827596763983, -0.6760001927614212], "quaternion": [0, 0, 0.8932451604797366, -0.44956988698035577] }]

    obbList.push(...obbList)
    obbList.push(...obbList)
    obbList.push(...obbList)

    let t = performance.now()
    for (let i = 0; i < 1000_0000; i++) {
        points[i * 3] = randFloat(-2, 2)
        points[i * 3 + 1] = randFloat(-2, 2)
        points[i * 3 + 2] = randFloat(-2, 2)
    }
    console.log("数据准备耗时", performance.now() - t, "ms")

    // 开始计算
    t = performance.now()
    const group = gpuComputed.createBindGroup({
        obbList,
        points,
        results: new Uint32Array(points.length / 3 / 2).fill(0),
    })
    console.log("数据写入缓冲区耗时", performance.now() - t, "ms")
    t = performance.now()
    const [results] = await gpuComputed.computed(group, [Math.ceil(points.length / 3 / 256)], ["results"])
    console.log("gpu计算 + 直接读回耗时", performance.now() - t, "ms")
    console.log("点云数据量：", points.length / 3, "盒子数量：", obbList.length)
    GpuComputed.destroy()

    // console.log([...new Uint16Array(results)])
}
start()

/**
数据准备耗时 197.3778 ms
数据写入缓冲区耗时 118.82940000000002 ms
gpu计算 + 直接读回耗时 70.50570000000005 ms
点云数据量： 10000000 盒子数量： 408
 */
</script>
